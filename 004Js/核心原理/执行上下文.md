# 核心原理-如何理解执行上下文


> 　当代码运行时，会产生一个对应的执行环境，在这个环境中，所有变量会被事先提出来（变量提升），有的直接赋值，有的为默认值 undefined，代码从上往下开始执行，就叫做执行上下文

+ 单线程，在主进程上运行
+ 同步执行，从上往下按顺序执行
+ 全局上下文只有一个，浏览器关闭时会被弹出栈
+ 函数的执行上下文没有数目限制
+ 函数每被调用一次，执行上下文环境

#### 一、执行上下文过程

+ 创建 
   + 创建活动对象
   + 生成变量对象 (标识符绑定)
   + 建立作用域链 (当前作用域、上一级作用域 , 包含整个执行过程中的活动对象引用 )
   + 确定 this 指向 (指向最终执行的上下文或对象)

+ 销毁
   + 执行完毕出栈，作用域链中活动对象scoped改0 等待回收被销毁

#### 二、js运行环境

+ 全局环境 window

+ 函数环境 ，函数作用域

+ eval函数 ， ThisBinding，LexicalEnvironment，VariableEnvironment 3种

#### 三、eval函数

> 调用eval函数时，JavaScript会创建新的执行环境, 包括： ThisBinding，LexicalEnvironment，VariableEnvironment 3种

+ Variable Environemnt 环境变量， 标识符绑定 ，然后指向 LexicalEnvironment

+ Lexical Environment 词汇环境

+ ThisBinding 当前绑定 (一般是全局对象)

#### 四、eval函数的作用与返回值

返回值

+ undefined
+ string 返回最后一个执行段的字符串

作用

+ 变量赋值
```js
eval("y = 2; i =2");
```
+ 对象定义
```js
eval("({b:2})");
```
+ 函数执行
```js
eval("innerFn()")
```
+ 间接调用
```js
var type = eval;// 模仿 ts 的 type 定义数据类型
type("var k = 1;");
console.log(k);// 1
```

执行原理层面

+ js新建一个执行环境时进行标识符绑定 , 绑定的标识符放到执行环境 VariableEnvironment 指向的 Lexical Environment中

+ eval函数的VariableEnvironment 与fn的VariableEnvironment  指向 同一个Lexical Environment

+ eval中声明的局部变量y被绑定到调用方 fn 的Lexical Environment中

+ eval执行完成，eval相关的执行环境被弹出栈顶

+ 但是因为 Lexical Environment 中还有绑定了的y，且 ThisBinding 是window 所以还可以访问


#### 五、eval函数的影响

+ 不可预知的变量提升
+ 定义变量会有驻留的情况
+ 不会创建一个新的作用域，并且它的作用域就是它所在的作用域
+ IE9之前，无论eval是直接调用还是间接调用，eval都当成直接调用处理，如果需要有间接调用的效果，可以使用IE提供的execScript函数


 
 
 